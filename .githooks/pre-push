#!/bin/sh
# Git pre-push hook
# Runs code quality checks before allowing push

# Initialize status tracking
OVERALL_STATUS=0
FORMAT_STATUS="â³"
LINT_STATUS="â³"
SPELL_STATUS="â³"
TYPE_STATUS="â³"
TEST_STATUS="â³"

echo "ğŸ” Running pre-push checks..."
echo ""

# 1. Format check
echo "ğŸ“ Checking code formatting..."
FORMAT_OUTPUT=$(mktemp)
cargo fmt --check > "$FORMAT_OUTPUT" 2>&1
FMT_EXIT=$?
taplo format --check >> "$FORMAT_OUTPUT" 2>&1
TAPLO_EXIT=$?
if [ $FMT_EXIT -eq 0 ] && [ $TAPLO_EXIT -eq 0 ]; then
    FORMAT_STATUS="âœ… PASS"
    echo "âœ… Formatting check passed"
else
    FORMAT_STATUS="âŒ FAIL"
    echo "âŒ Code formatting failed. Run 'make fmt' to fix."
    OVERALL_STATUS=1
fi
rm -f "$FORMAT_OUTPUT"
echo ""

# 2. Linting
echo "ğŸ” Running linter..."
CLIPPY_OUTPUT=$(mktemp)
cargo clippy --all-targets --all-features -- -D warnings > "$CLIPPY_OUTPUT" 2>&1
CLIPPY_EXIT=$?
if [ $CLIPPY_EXIT -eq 0 ]; then
    LINT_STATUS="âœ… PASS"
    echo "âœ… Linting passed"
else
    LINT_STATUS="âŒ FAIL"
    echo "âŒ Clippy found issues. Fix them before pushing."
    OVERALL_STATUS=1
fi
rm -f "$CLIPPY_OUTPUT"
echo ""

# 3. Spell check
echo "ğŸ“– Checking spelling..."
TYPOS_OUTPUT=$(mktemp)
typos > "$TYPOS_OUTPUT" 2>&1
TYPOS_EXIT=$?
if [ $TYPOS_EXIT -eq 0 ]; then
    SPELL_STATUS="âœ… PASS"
    echo "âœ… Spell check passed"
else
    SPELL_STATUS="âŒ FAIL"
    echo "âŒ Typos found. Run 'make spell-fix' to fix."
    OVERALL_STATUS=1
fi
rm -f "$TYPOS_OUTPUT"
echo ""

# 4. Type check
echo "ğŸ”§ Type checking..."
CHECK_OUTPUT=$(mktemp)
cargo check --all-targets > "$CHECK_OUTPUT" 2>&1
CHECK_EXIT=$?
if [ $CHECK_EXIT -eq 0 ]; then
    TYPE_STATUS="âœ… PASS"
    echo "âœ… Type check passed"
else
    TYPE_STATUS="âŒ FAIL"
    echo "âŒ Type check failed. Fix errors before pushing."
    OVERALL_STATUS=1
fi
rm -f "$CHECK_OUTPUT"
echo ""

# 5. Tests
echo "ğŸ§ª Running tests..."
TEST_OUTPUT=$(mktemp)
cargo test --all-targets > "$TEST_OUTPUT" 2>&1
TEST_EXIT=$?
if [ $TEST_EXIT -eq 0 ]; then
    TEST_STATUS="âœ… PASS"
    echo "âœ… Tests passed"
else
    TEST_STATUS="âŒ FAIL"
    echo "âŒ Tests failed. Fix failing tests before pushing."
    OVERALL_STATUS=1
fi
rm -f "$TEST_OUTPUT"
echo ""

# Display summary
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š PRE-PUSH CHECKS SUMMARY"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
printf "%-25s %s\n" "Code Formatting (fmt)" "$FORMAT_STATUS"
printf "%-25s %s\n" "Linting (clippy)" "$LINT_STATUS"
printf "%-25s %s\n" "Spell Check (typos)" "$SPELL_STATUS"
printf "%-25s %s\n" "Type Check (cargo check)" "$TYPE_STATUS"
printf "%-25s %s\n" "Tests (cargo test)" "$TEST_STATUS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ $OVERALL_STATUS -eq 0 ]; then
    echo "ğŸ‰ All checks passed! Proceeding with push..."
    exit 0
else
    echo "âŒ Some checks failed. Please fix the issues before pushing."
    exit 1
fi
